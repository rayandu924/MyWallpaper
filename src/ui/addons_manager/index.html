<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="index.css">
    <title>Addon Manager</title>
</head>
<body>
    <div class="container">
        <div id="addon-list">
            <h3>List of Addons</h3>
            <ul id="addons">
                <!-- The addons will be listed here -->
            </ul>
        </div>
        <div id="addon-config">
            <h3>Addon Configuration</h3>
            <div id="config-editor">
                <!-- Configuration will be displayed here -->
            </div>
        </div>
    </div>
</body>
<script src="https://cdnjs.cloudflare.com/ajax/libs/Sortable/1.14.0/Sortable.min.js"></script>
<script>
    let currentAddon = null;
    let currentConfig = {};  // Store the full configuration here
    let addonOrder = [];

    function loadConfig(addon) {
        currentAddon = addon;
        window.pywebview.api.load_config(addon).then(config => {
            currentConfig = config;  // Store the full config
            const editor = document.getElementById('config-editor');
            editor.innerHTML = ''; // Clear previous configuration

            for (let key in config) {
                const configItem = config[key];
                const div = document.createElement('div');
                div.classList.add('config-item');

                const label = document.createElement('label');
                label.textContent = `${key} (${configItem.varType})`;
                div.appendChild(label);

                const input = createInput(configItem);

                if (input) {
                    input.oninput = () => handleInputChange(input, key);
                    div.appendChild(input);
                }

                editor.appendChild(div);
            }
        });
    }

    function createInput(configItem) {
        let input;
        switch (configItem.inputType) {
            case 'slider':
                input = document.createElement('input');
                input.type = 'range';
                input.min = configItem.min || 0;
                input.max = configItem.max || 100;
                input.value = configItem.value;
                input.step = configItem.varType === 'float' ? "0.01" : "1";
                break;
            case 'color':
                input = document.createElement('input');
                input.type = 'color';
                input.value = configItem.value || '#000000';
                break;
            case 'checkbox':
                input = document.createElement('input');
                input.type = 'checkbox';
                input.checked = !!configItem.value;
                break;
            case 'number':
                input = document.createElement('input');
                input.type = 'number';
                input.value = configItem.value;
                input.min = configItem.min || null;
                input.max = configItem.max || null;
                break;
            case 'text':
                input = document.createElement('input');
                input.type = 'text';
                input.value = configItem.value || '';
                break;
            case 'textarea':
                input = document.createElement('textarea');
                input.value = configItem.value || '';
                break;
            default:
                console.warn(`Unknown inputType: ${configItem.inputType}`);
                break;
        }
        return input;
    }

    function handleInputChange(input, key) {
        if (input.type === 'checkbox') {
            currentConfig[key].value = input.checked;
        } else {
            currentConfig[key].value = input.type === 'number' ? parseFloat(input.value) : input.value;
        }
        saveConfig();
    }

    function saveConfig() {
        window.pywebview.api.save_config(currentAddon, currentConfig);
    }

    function enableDragAndDrop() {
        const list = document.getElementById('addons');
        new Sortable(list, {
            animation: 150,
            onEnd: () => {
                const order = Array.from(list.children).map(li => li.textContent);
                addonOrder = order;
                window.pywebview.api.save_addon_order(order);
            }
        });
    }

    function checkPyWebViewReady() {
        if (window.pywebview && window.pywebview.api) {
            window.pywebview.api.get_addons().then(addons => {
                const ul = document.getElementById('addons');
                ul.innerHTML = ''; // Reset addons list

                addons.forEach(addon => {
                    const li = document.createElement('li');
                    li.textContent = addon;
                    li.onclick = () => loadConfig(addon);
                    ul.appendChild(li);
                });

                enableDragAndDrop();
            });
        } else {
            setTimeout(checkPyWebViewReady, 100);
        }
    }

    document.addEventListener('DOMContentLoaded', function() {
        checkPyWebViewReady();
    });
</script>
</html>
