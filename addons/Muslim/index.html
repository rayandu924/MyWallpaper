<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Prayer Time Widget</title>

    <!-- Configuration JSON -->
    <script id="config" type="application/json">{
    "fontURL": {
        "value": "https://fonts.googleapis.com/css2?family=Roboto:wght@400;700&display=swap",
        "varType": "string",
        "inputType": "text"
    },
    "textColor": {
        "value": "#ffffff",
        "varType": "color",
        "inputType": "color"
    },
    "backgroundColor": {
        "value": "#000000",
        "varType": "string",
        "inputType": "color"
    },
    "widgetWidth": {
        "value": "273",
        "varType": "number",
        "inputType": "slider",
        "min": 200,
        "max": 500
    },
    "widgetHeight": {
        "value": "103",
        "varType": "number",
        "inputType": "slider",
        "min": 100,
        "max": 300
    },
    "position": {
        "value": "bottom",
        "varType": "string",
        "inputType": "text"
    },
    "timeFormat": {
        "value": true,
        "varType": "boolean",
        "inputType": "checkbox"
    },
    "showSeconds": {
        "value": true,
        "varType": "boolean",
        "inputType": "checkbox"
    },
    "latitude": {
        "value": 40.7128,
        "varType": "number",
        "inputType": "number"
    },
    "longitude": {
        "value": -74.006,
        "varType": "number",
        "inputType": "number"
    }
}</script>

    <style>
        :root {
            --font-family: 'Arial, sans-serif';
            --text-color: var(--text-color, #FFFFFF);
            --background-color: rgba(0, 0, 0, 0.5);
            --widget-width: 300px;
            --widget-height: 150px;
        }

        body {
            margin: 0;
            font-family: var(--font-family);
            background: transparent;
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
            color: var(--text-color);
            font-size: 1.2em;
        }

        .prayer-widget {
            width: var(--widget-width);
            height: var(--widget-height);
            background-color: var(--background-color);
            border-radius: 15px;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            padding: 10px;
            text-align: center;
        }

        .prayer-name {
            font-size: 1.5em;
            margin-bottom: 10px;
        }

        .prayer-time {
            font-size: 2em;
        }

        .position-top-left {
            position: absolute;
            top: 10px;
            left: 10px;
        }

        .position-top-right {
            position: absolute;
            top: 10px;
            right: 10px;
        }

        .position-bottom-left {
            position: absolute;
            bottom: 10px;
            left: 10px;
        }

        .position-bottom-right {
            position: absolute;
            bottom: 10px;
            right: 10px;
        }
    </style>
</head>

<body>
    <div id="prayerWidget" class="prayer-widget">
        <div class="prayer-name" id="prayerName">Loading...</div>
        <div class="prayer-time" id="prayerTime">--:--</div>
    </div>

    <script>
        // Fetch and parse the JSON configuration from the <head> section
        const configScript = document.getElementById('config');
        const config = JSON.parse(configScript.textContent);

        // Apply font from the config
        const link = document.createElement('link');
        link.rel = 'stylesheet';
        link.href = config.fontURL.value;
        document.head.appendChild(link);
        document.documentElement.style.setProperty('--font-family', "'Roboto', sans-serif");

        // Apply dynamic styling based on config
        document.documentElement.style.setProperty('--text-color', config.textColor.value);
        document.documentElement.style.setProperty('--background-color', config.backgroundColor.value);
        document.documentElement.style.setProperty('--widget-width', config.widgetWidth.value + 'px');
        document.documentElement.style.setProperty('--widget-height', config.widgetHeight.value + 'px');

        // Set widget position from the config
        const widget = document.getElementById('prayerWidget');
        widget.classList.add(`position-${config.position.value}`);

        // Function to fetch prayer times
        async function fetchPrayerTimes() {
            const response = await fetch(`http://api.aladhan.com/v1/timings?latitude=${config.latitude.value}&longitude=${config.longitude.value}&method=2`);
            const data = await response.json();
            return data.data.timings;
        }

        // Function to calculate time difference
        function calculateTimeDifference(currentTime, prayerTime) {
            const timeNow = new Date(currentTime);
            const timeTarget = new Date(prayerTime);
            const diff = timeTarget - timeNow;
            let hours = Math.floor(diff / 1000 / 60 / 60);
            let minutes = Math.floor((diff / 1000 / 60) % 60);
            let seconds = Math.floor((diff / 1000) % 60);

            return { hours, minutes, seconds };
        }

        // Update the widget
        async function updateWidget() {
            const prayerTimes = await fetchPrayerTimes();

            const currentTime = new Date();
            const prayers = ["Fajr", "Dhuhr", "Asr", "Maghrib", "Isha"];
            let nextPrayer = "";
            let nextPrayerTime = "";

            prayers.forEach(prayer => {
                const prayerTime = new Date(`${currentTime.toDateString()} ${prayerTimes[prayer]}`);
                if (currentTime < prayerTime && !nextPrayer) {
                    nextPrayer = prayer;
                    nextPrayerTime = prayerTime;
                }
            });

            if (!nextPrayer) {
                nextPrayer = prayers[0];
                nextPrayerTime = new Date(`${currentTime.toDateString()} ${prayerTimes[prayers[0]]}`);
                nextPrayerTime.setDate(nextPrayerTime.getDate() + 1);
            }

            const { hours, minutes, seconds } = calculateTimeDifference(currentTime, nextPrayerTime);

            document.getElementById('prayerName').innerText = nextPrayer;
            document.getElementById('prayerTime').innerText = config.timeFormat.value
                ? nextPrayerTime.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit', second: config.showSeconds.value ? '2-digit' : undefined, hour12: false })
                : nextPrayerTime.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit', second: config.showSeconds.value ? '2-digit' : undefined, hour12: true });
        }

        setInterval(updateWidget, 1000); // Update every second
    </script>
</body>

</html>
